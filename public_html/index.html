<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Finance tracker</title>
    <script src="js/jquery-3.4.1.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script>
        function getAllAccounts() {
            $.get("controller/account_controller/getAll.php", {user_id: sessionStorage.getItem("id")}, function (data) {
                let response = JSON.parse(data);
                if (response.status === true) {
                    let table = $("<table />");
                    table.attr("id", "appended-table");

                    $.each(response.data, function (key, value) {
                        let tr = $("<tr />");
                        $.each(value, function (k, v) {
                            let td = $("<td />").text(v);
                            tr.append(td);
                        });
                        table.append(tr);
                    });

                    $("#container").html(table);
                }
            });
        }
        $(document).ready(function () {
            let url = "view/user/login.html";
            if (sessionStorage.getItem("id") !== null) {
                url = "view/main.html";
                $.get("view/menu.html", function (data) {
                    $("#menu").html(data);
                });
            }
            $.get(url, function (data) {
                $("#container").html(data);
            });

            $(document).on("click", '.loader', function(event) {
                event.preventDefault();
                let href = 'view/' + $(this).attr("href");
                $.get(href, function (data) {
                    let cont = $("#container");
                    cont.empty();
                    cont.html(data);
                });
            });
            $(document).on("click", ':submit', function (e) {
                e.preventDefault();
                let form = $(this).closest("form");
                let action = form.attr("action");
                let data = form.serialize() + '&' + $(this).attr("name");
                $.post(action, data, function (data) {
                    let response = JSON.parse(data);
                    if (response.status === true) {
                        if (response.target === 'register') {
                            alert('Registration succesfull!');
                            $.get('view/user/login.html', function (data) {
                                $("#container").html(data);
                            });
                        } else if(response.target === 'login') {
                            alert("Login succesfull!");
                            sessionStorage.setItem("name", response.full_name);
                            sessionStorage.setItem("id", response.id);
                            $.get("view/menu.html", function (data) {
                                $("#menu").html(data);
                            });

                            $.get("view/main.html", function (data) {

                                $("#container").html(data);
                            });
                        } else if(response.target === 'addaccount') {
                            alert('Account added succesfully!');
                            getAllAccounts();
                        }
                    }
                });
            })
        });
    </script>
</head>
<body>
<div id="menu"></div>
<div id="container"></div>
</body>
</html>